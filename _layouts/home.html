<!DOCTYPE html>
<html lang="ja">
<head>
    {% include head.html %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.css">
    <style>
        html.lenis, html.lenis body { height: auto; }
        .lenis.lenis-smooth { scroll-behavior: auto !important; }
        .lenis.lenis-stopped { overflow: hidden; }
        body.no-scroll { overflow: hidden; }

        /* --- Opener --- */
        #opener { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10000; background-color: var(--background); transition: opacity 0.5s ease-out; display: flex; justify-content: center; align-items: center; }
        .opener-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .opener-layer.hidden { display: none; }
        #video-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85vw; aspect-ratio: 16 / 9; box-shadow: 0 0 35px 5px rgba(184, 159, 93, 0.2); }
        #opening-video { width: 100%; height: 100%; object-fit: contain; }
        #loader { flex-direction: column; }
        #loader-logo { max-width: 400px; width: 70%; opacity: 0; }
        #loader-percentage { font-family: 'Lato', sans-serif; font-size: 1rem; color: var(--text-muted); margin-top: 1.5rem; z-index: 10; }
        .loader-border { position: absolute; background-color: var(--accent-gold); box-shadow: 0 0 15px var(--accent-gold); }
        .loader-border-top { top: 0; left: 0; width: 0; height: 2px; }
        .loader-border-right { top: 0; right: 0; width: 2px; height: 0; }
        .loader-border-bottom { bottom: 0; right: 0; width: 0; height: 2px; }
        .loader-border-left { bottom: 0; left: 0; width: 2px; height: 0; }

        /* --- Horizontal Scroll Layout (Restored) --- */
        #main-pin-container { width: 100%; height: 100vh; overflow: hidden; }
        #main-content-wrapper { width: 500%; height: 100%; display: flex; flex-wrap: nowrap; }
        .section { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; padding: 6rem 4rem; position: relative; }
        .section-content { max-width: 1200px; width: 100%; z-index: 1; }
        .section-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0.15; }

        /* --- Collections Gallery --- */
        .gallery-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 1.5rem; padding: 2rem 0; -ms-overflow-style: none; scrollbar-width: none; cursor: grab; }
        .gallery-container:active { cursor: grabbing; }
        .gallery-container::-webkit-scrollbar { display: none; }
        .gallery-item { flex: 0 0 60%; scroll-snap-align: center; border-radius: 8px; overflow: hidden; cursor: pointer; }
        @media (min-width: 768px) { .gallery-item { flex-basis: 40%; } }
        .gallery-item img, .gallery-item picture { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="no-scroll">

    <!-- Opener -->
    <div id="opener">
        <div id="video-container" class="opener-layer">
            <video id="opening-video" autoplay muted playsinline src="{{ '/open.anim.mp4' | relative_url }}">Your browser does not support the video tag.</video>
        </div>
        <div id="loader" class="opener-layer hidden">
            <div class="loader-border loader-border-top"></div>
            <div class="loader-border loader-border-right"></div>
            <div class="loader-border loader-border-bottom"></div>
            <div class="loader-border loader-border-left"></div>
            <img id="loader-logo" src="{{ '/images/rogo.webp' | relative_url }}" alt="Regalis Logo" loading="lazy">
            <div id="loader-percentage">0%</div>
        </div>
    </div>

    {% include header.html %}

    {{ content }}
    
    {% include footer.html %}

    <script src="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.27/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://unpkg.com/split-type"></script>
    <script src="{{ '/assets/js/main.js' | relative_url }}" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            gsap.set("#main-pin-container", {visibility: "visible"});

            const opener = document.getElementById('opener');
            const openingVideo = document.getElementById('opening-video');
            const videoContainer = document.getElementById('video-container');
            const mainPinContainer = document.getElementById('main-pin-container');
            const loader = document.getElementById('loader');
            const loaderLogo = document.getElementById('loader-logo');
            const loaderPercentage = document.getElementById('loader-percentage');

            const initMainContent = () => {
                document.body.classList.remove('no-scroll');
                initHorizontalScroll();
                initLightbox();
            };

            const revealMainContent = () => {
                const tl = gsap.timeline();
                tl.to(opener, { 
                    opacity: 0, 
                    duration: 0.6, 
                    onComplete: () => opener.style.display = 'none'
                })
                .fromTo(mainPinContainer, 
                    { autoAlpha: 0 }, 
                    { autoAlpha: 1, duration: 1.0, ease: "power2.out", onStart: initMainContent },
                    ">-0.3"
                );
            };

            const startLoader = () => {
                if (videoContainer) videoContainer.style.display = 'none';
                if (loader) loader.classList.remove('hidden');
                if (loaderLogo) loaderLogo.style.opacity = 0;

                const tl = gsap.timeline({ onComplete: () => setTimeout(revealMainContent, 200) });
                tl.to(".loader-border-top", { width: '100%', duration: 0.7 })
                  .to(".loader-border-right", { height: '100%', duration: 0.5 })
                  .to(".loader-border-bottom", { width: '100%', duration: 0.7 })
                  .to(".loader-border-left", { height: '100%', duration: 0.5 });

                gsap.to(loaderLogo, { opacity: 1, duration: tl.duration() * 0.8, ease: "power1.out" });
                
                const percentage = { val: 0 };
                gsap.to(percentage, {
                    val: 100,
                    duration: tl.duration(),
                    ease: "none",
                    onUpdate: () => {
                        if(loaderPercentage) loaderPercentage.textContent = `${Math.floor(percentage.val)}%`;
                    }
                });
            };

            if (openingVideo) {
                openingVideo.addEventListener('ended', startLoader);
                openingVideo.play().catch(startLoader);
            } else {
                startLoader();
            }

            const lenis = new Lenis();
            lenis.on('scroll', ScrollTrigger.update);
            gsap.ticker.add((time) => {
                lenis.raf(time * 1000);
            });
            gsap.ticker.lagSmoothing(0);

            function initHorizontalScroll() {
                gsap.registerPlugin(ScrollTrigger, SplitText);
                const sections = gsap.utils.toArray(".section");
                const mainContentWrapper = document.getElementById('main-content-wrapper');
                const navLinks = document.querySelectorAll('#mobile-nav .nav-item');
                const footer = document.getElementById('main-footer');

                const totalWidth = mainContentWrapper.scrollWidth - window.innerWidth;
                document.body.style.height = totalWidth + footer.offsetHeight + "px";

                const pinTrigger = ScrollTrigger.create({
                    trigger: "#main-pin-container",
                    pin: true,
                    start: "top top",
                    end: () => `+=${totalWidth}`,
                    scrub: 2,
                    onUpdate: self => {
                        const progress = self.progress;
                        const activeIndex = Math.floor(progress * (sections.length - 1));
                        const activeSection = sections[activeIndex];
                        if (activeSection) {
                            setActive(activeSection.id);
                        }
                    }
                });

                let scrollTween = gsap.to(mainContentWrapper, {
                    x: () => -totalWidth,
                    ease: "none",
                    scrollTrigger: {
                        trigger: "#main-pin-container",
                        start: "top top",
                        end: () => `+=${totalWidth}`,
                        scrub: true,
                    }
                });

                gsap.to(footer, {
                    y: (i, target) => -(target.offsetHeight),
                    ease: "none",
                    scrollTrigger: {
                        trigger: "body",
                        start: () => `bottom-=${footer.offsetHeight} bottom`,
                        end: "bottom bottom",
                        scrub: true,
                    },
                });

                function setActive(id) {
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.dataset.nav === id) {
                            link.classList.add('active');
                        }
                    });
                }

                // Hero Title Animation
                const heroTitle = new SplitType('.hero-title-line', { types: 'words' });
                gsap.from(heroTitle.words, {
                    yPercent: 100,
                    stagger: 0.05,
                    duration: 1,
                    ease: "power2.out",
                    scrollTrigger: {
                        trigger: "#hero",
                        containerAnimation: scrollTween,
                        start: "left 80%",
                        toggleActions: "play none none reverse",
                    }
                });

                // Ken Burns Effect for Hero BG
                gsap.to("#hero .section-background", {
                    scale: 1.2,
                    ease: "none",
                    scrollTrigger: {
                        trigger: "#hero",
                        containerAnimation: scrollTween,
                        start: "left right",
                        end: "right left",
                        scrub: true
                    }
                });

                // General Element Animations
                sections.forEach((section) => {
                    if (section.id === 'hero') return;
                    const elems = gsap.utils.toArray(section.querySelectorAll("h2, p, a, .gallery-container"));
                    gsap.from(elems, {
                        y: 75,
                        opacity: 0,
                        stagger: 0.1,
                        duration: 0.8,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: section,
                            containerAnimation: scrollTween,
                            start: "left 85%",
                            toggleActions: "play none none reverse",
                        }
                    });
                });
            }

            function initLightbox() {
                document.querySelectorAll('.gallery-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const img = item.querySelector('img');
                        if(img) {
                            const imgSrc = img.src;
                            basicLightbox.create(`<img src="${imgSrc}">`).show();
                        }
                    });
                });
            }
        });
    </script>

</body>
</html>